<html>
<head>
</head>
<title>livecamera</title>
<body>
<img id="liveImg" src="" width="480" height="360">
<canvas id="canvas"></canvas><br>
<form name="mode">
<input type="button" id="normal" value="normal Mode" onclick="normalMode(), disable(this)" disabled="disabled">
<input type="button" id="edge" value="edge Mode" onclick="edgeMode(), disable(this)">
<input type="button" id="motion" value="motion Mode" onclick="motionMode(), disable(this)">
<input type="button" id="gray" value="gray Mode" onclick="grayMode(), disable(this)">
</form>
Frames per second : <input type="number" id="fps" value="1.0" step="0.1" min="0" max="8" onmousedown="setInfo('');"><br>
Video length : <input type="number" id="len" value="2.0" step="0.5" max="50" min="0.5" onmousedown="setInfo('');" /> seconds <br>
<input type="button" id="start" value="start recording" onclick="startTimeLapse()"/><br>
<div id="duration"></div>
<script type="text/javascript">
var img = document.getElementById("liveImg");
var duration = document.getElementById("duration");
var count;
var ws = new WebSocket("ws://localhost:8080/camera");
ws.binaryType = 'blob';

window.onload = function(){
        setInfo();
};

ws.onopen = function(){
	console.log("connection was established");
};

ws.onmessage = function(evt){
    if(evt.data.size > 100){
        img.src = URL.createObjectURL(evt.data);
    }
    else{
        if(evt.data == "recording"){
            console.log("now recording");
            STATE = "recording";
            drawRec();
            setInfo(STATE)
        }
        else if(evt.data.indexOf("remaining") != -1){
            console.log("remaining"); //TODO receive remaining time
        }
    }
    //ccc.drawImage(img.src,0,0);
};

window.onbeforeunload = function(){
    ws.close(1000); //Is this needed??
};

function drawRec(){
    var canvas = document.getElementById("canvas");
    var context = canvas.getContext("2d");
    context.fillStyle = "red";
    context.font = "30px 'Arial'";
    context.textAlign = "start";
    context.textBaseline = "top";
    context.fillText("REC", 0, 0, 200);
}

function startTimeLapse() {
    cntStart();
    drawRec();
    document.getElementById("start").disabled = true;
    var fps = document.getElementById("fps").value;
    var length = document.getElementById("len").value;
    ws.send('["fps", %s]'.replace("%s", fps));
    ws.send('["length", %s]'.replace("%s", length));
}

var timer;
function cntStart(){
    timer = setInterval("cntDown()",1000);
}

function cntDown(){
    count -= 1;
    if(count <= 0){
        cntEnd();
    }
    else{
        updateInfo(count);
    }
}

function cntEnd(){
    duration.innerHTML = "Finish recording";
    clearInterval(timer);
}


function setInfo(STATE){
    if(STATE == "recording"){
        document.getElementById("start").disabled = true;
        duration.innerHTML = "Finish in several second";
    }
    else{
        var fps = parseFloat(document.getElementById("fps").value);
        var length = parseFloat(document.getElementById("len").value);
        count = (length*25)/fps;
        updateInfo(count);
    }
}

function updateInfo(time){
    time = time*10;
    tmp = "Recording lasts " + String(Math.round(time)/10)+" seconds.";
    duration.innerHTML = tmp;
}

function disable(button){
    document.getElementById("motion").disabled = false;
    document.getElementById("gray").disabled = false;
    document.getElementById("normal").disabled = false;
    document.getElementById("edge").disabled = false;
    button.disabled = true;
}

function motionMode(){ws.send('["motion"]');}
function grayMode(){ws.send('["gray"]');}
function normalMode(){ws.send('["normal"]');}
function edgeMode(){ws.send('["edge"]');}
</script>
</body>
</html>
